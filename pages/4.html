<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the rule of the third reflection — 4/50</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #030303;
            color: #e0e0e0;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1.2rem;
            line-height: 1.9;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            transition: opacity 0.4s ease;
            opacity: 1;
        }

        .video-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.22;
            z-index: 0;
            filter: brightness(0.58) contrast(1.35);
            will-change: transform;
        }

        .overlay-dark {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(5,5,5,0.82) 0%, rgba(3,3,3,0.96) 100%);
            z-index: 1;
        }

        .grain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            opacity: 0.03;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJmIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iLjc0IiBudW1PY3RhdmVzPSIzIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2YpIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=');
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.7) 140%);
        }

        .cursor-glow {
            position: fixed;
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(95, 75, 75, 0.07) 0%, transparent 80%);
            pointer-events: none;
            z-index: 98;
            transform: translate(-50%, -50%);
        }

        .page-number {
            position: fixed;
            top: 2rem;
            left: 2rem;
            font-size: 0.8rem;
            color: #555;
            letter-spacing: 3px;
            z-index: 70;
            font-family: 'Courier New', monospace;
            opacity: 0.8;
        }

        .living-icon {
            position: fixed;
            top: 2rem;
            right: 2rem;
            width: 32px;
            height: 32px;
            border: 1px solid #555;
            background: rgba(10,10,10,0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200;
            transition: all 0.3s ease;
            color: #aaa;
            font-size: 0.9rem;
        }

        .black-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 3s ease;
        }

        .black-screen-message {
            color: #333;
            font-size: 1.1rem;
            font-style: italic;
            letter-spacing: 3px;
            text-align: center;
            font-family: 'Courier New', monospace;
            opacity: 0;
            transition: opacity 5s ease;
        }

        .return-message {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background: rgba(5,5,5,0.9);
            border: 1px solid #444;
            padding: 0.9rem 1.8rem;
            color: #b0b0b0;
            font-size: 0.95rem;
            font-style: italic;
            letter-spacing: 2px;
            z-index: 300;
            opacity: 0;
            transition: opacity 1.2s ease;
            cursor: pointer;
            backdrop-filter: blur(5px);
            font-family: 'Courier New', monospace;
        }

        .return-message.visible {
            opacity: 0.9;
        }

        .content {
            position: relative;
            z-index: 50;
            max-width: 700px;
            margin: 0 auto;
            padding: 7rem 2rem 10rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .text-block {
            margin-bottom: 4.5rem;
            opacity: 0;
            transform: translateY(25px);
            transition: opacity 0.9s cubic-bezier(0.2, 0.9, 0.3, 1), transform 0.9s cubic-bezier(0.2, 0.9, 0.3, 1);
        }

        .text-block.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .text-block p {
            margin-bottom: 1.8rem;
            text-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .text-block .italic {
            font-style: italic;
            color: #c0c0c0;
            border-left: 2px solid #4a4a4a;
            padding-left: 1.5rem;
        }

        .revelation-box {
            margin: 3rem 0;
            padding: 2rem;
            border: 1px solid #5a5a5a;
            background: rgba(20,15,20,0.35);
            backdrop-filter: blur(3px);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.9s ease, transform 0.9s ease;
        }

        .revelation-box.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .revelation-text {
            color: #d0d0d0;
            font-size: 1.1rem;
            line-height: 1.8;
            text-align: center;
            font-style: italic;
        }

        .navigation {
            margin-top: 3rem;
            display: flex;
            justify-content: space-between;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .navigation.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .nav-button {
            background: transparent;
            border: 1px solid #5a5a5a;
            color: #d0d0d0;
            padding: 0.8rem 2rem;
            font-size: 0.9rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
        }

        .nav-button:hover {
            border-color: #888;
            color: #fff;
            background: rgba(255,255,255,0.02);
        }

        .prev-button::before {
            content: '←';
            margin-right: 0.6rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .prev-button:hover::before {
            opacity: 1;
        }

        .next-button::after {
            content: '→';
            margin-left: 0.6rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .next-button:hover::after {
            opacity: 1;
        }

        @keyframes shake {
            0% { transform: translate(0,0); }
            20% { transform: translate(2px, -1px); }
            40% { transform: translate(-2px, 1px); }
            60% { transform: translate(1px, -1px); }
            80% { transform: translate(-1px, 1px); }
            100% { transform: translate(0,0); }
        }

        .shake-effect {
            animation: shake 0.3s ease;
        }

        @keyframes glitch {
            0% { transform: translate(0); filter: hue-rotate(0deg); }
            20% { transform: translate(-2px, 1px); filter: hue-rotate(5deg); }
            40% { transform: translate(2px, -1px); filter: hue-rotate(-5deg); }
            60% { transform: translate(-1px, 2px); filter: hue-rotate(3deg); }
            80% { transform: translate(1px, -2px); filter: hue-rotate(-3deg); }
            100% { transform: translate(0); filter: hue-rotate(0deg); }
        }

        .glitch-effect {
            animation: glitch 0.4s ease;
        }

        .red-bleed {
            box-shadow: inset 0 0 30px rgba(80, 20, 20, 0.3);
            transition: box-shadow 0.5s ease;
        }

        @keyframes subtle-flicker {
            0%, 100% { opacity: 1; }
            95% { opacity: 0.95; }
        }

        body {
            animation: subtle-flicker 26s infinite;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        html {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .parallax {
            transition: transform 0.15s cubic-bezier(0.2, 0, 0.3, 1);
        }

        @media (max-width: 768px) {
            .content { padding: 6rem 1.8rem 8rem; }
            .page-number { top: 1.5rem; left: 1.5rem; }
            .living-icon { top: 1.5rem; right: 1.5rem; }
            .return-message { bottom: 1.5rem; left: 1.5rem; }
            .revelation-box { padding: 1.5rem; }
            .navigation { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <video class="video-layer parallax" autoplay muted loop playsinline>
        <source src="Assets/Videos/back2.mp4" type="video/mp4">
    </video>
    <div class="overlay-dark"></div>

    <div class="grain"></div>
    <div class="vignette"></div>
    <div class="cursor-glow" id="cursorGlow"></div>

    <div class="page-number">4/50</div>

    <div class="living-icon" id="livingIcon">
        <span>●</span>
    </div>

    <div class="black-screen" id="blackScreen">
        <div class="black-screen-message" id="blackScreenMessage"></div>
    </div>

    <div class="return-message" id="returnMessage">
        Noh, Go back...
    </div>

    <div class="content">
        <div class="text-block">
            <p>The next morning, you checked the mirror again. The third reflection was still there. Still delayed.</p>
        </div>

        <div class="text-block">
            <p>You began to test it. You raised your hand quickly. The first and second reflections matched. The third waited one beat. Two. Then raised its hand.</p>
        </div>

        <div class="text-block">
            <p class="italic">Not copying. Responding.</p>
        </div>

        <div class="text-block">
            <p>You spent that week learning its patterns. It was faster at night. Slower when you were tired. Once, when you approached the mirror without turning on the light, it didn't move at all.</p>
        </div>

        <div class="revelation-box" id="revelationBox">
            <div class="revelation-text">
                Your grandmother's mirror does not show what is behind you.<br>
                It shows what is waiting.
            </div>
        </div>

        <div class="text-block">
            <p>You called your mother. Asked about the mirror. There was silence on the line. Then:</p>
        </div>

        <div class="text-block">
            <p class="italic">"She never told you? The mirror isn't ours. It came with the house. The previous owners left it behind."</p>
        </div>

        <div class="text-block">
            <p>They left it behind. For sixty years, your grandmother looked into a stranger's mirror. And the stranger, somewhere in the reflection, looked back.</p>
        </div>

        <div class="navigation" id="navigation">
            <button class="nav-button prev-button" id="prevBtn">Previous</button>
            <button class="nav-button next-button" id="nextBtn">Continue</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            localStorage.setItem('lastPage', 'pages/page4.html');

            const previousPage = localStorage.getItem('previousPage');
            const returnMessage = document.getElementById('returnMessage');

            if (previousPage && parseInt(previousPage.split('/')[1].replace('page', '').split('.')[0]) > 4) {
                setTimeout(() => {
                    returnMessage.classList.add('visible');
                }, 1800);
                setTimeout(() => {
                    returnMessage.classList.remove('visible');
                }, 9800);
                returnMessage.addEventListener('click', function() {
                    const lastPage = localStorage.getItem('lastPage');
                    if (lastPage && lastPage !== 'pages/page4.html') {
                        window.location.href = lastPage;
                    }
                });
            }

            localStorage.setItem('previousPage', 'pages/page4.html');

            // Get choice from page 3 to subtly adjust tone
            const choicePage3 = localStorage.getItem('choice_page3');

            const textBlocks = document.querySelectorAll('.text-block');
            const revelationBox = document.getElementById('revelationBox');
            const navigation = document.getElementById('navigation');

            function revealOnScroll() {
                textBlocks.forEach(block => {
                    const rect = block.getBoundingClientRect();
                    if (rect.top < window.innerHeight * 0.85 && rect.bottom > 0) {
                        block.classList.add('visible');
                    }
                });

                if (revelationBox) {
                    const rect = revelationBox.getBoundingClientRect();
                    if (rect.top < window.innerHeight * 0.8 && rect.bottom > 0) {
                        revelationBox.classList.add('visible');
                    }
                }

                const lastBlock = textBlocks[textBlocks.length - 1];
                if (lastBlock) {
                    const rect = lastBlock.getBoundingClientRect();
                    if (rect.top < window.innerHeight * 0.6) {
                        navigation.classList.add('visible');
                    }
                }
            }

            window.addEventListener('scroll', revealOnScroll);
            setTimeout(revealOnScroll, 200);
            setTimeout(revealOnScroll, 600);

            // Subtle tone adjustment based on previous choice
            if (choicePage3) {
                setTimeout(() => {
                    const revelationText = document.querySelector('.revelation-text');
                    if (revelationText) {
                        switch(choicePage3) {
                            case 'A':
                                revelationText.innerHTML = 'Your grandmother\'s mirror does not show what is behind you.<br>It shows what has been waiting for you to come closer.';
                                break;
                            case 'B':
                                revelationText.innerHTML = 'Your grandmother\'s mirror does not show what is behind you.<br>It shows what respects your distance.';
                                break;
                            case 'C':
                                revelationText.innerHTML = 'Your grandmother\'s mirror does not show what is behind you.<br>It shows what waits in darkness.';
                                break;
                            case 'D':
                                revelationText.innerHTML = 'Your grandmother\'s mirror does not show what is behind you.<br>It shows what you touched first.';
                                break;
                        }
                    }
                }, 1000);
            }

            const cursorGlow = document.getElementById('cursorGlow');
            document.addEventListener('mousemove', function(e) {
                cursorGlow.style.left = e.clientX + 'px';
                cursorGlow.style.top = e.clientY + 'px';
            });

            const video = document.querySelector('.video-layer');
            window.addEventListener('scroll', function() {
                const scrollY = window.scrollY;
                const maxScroll = document.body.scrollHeight - window.innerHeight;
                const scrollPercent = scrollY / maxScroll;
                video.style.transform = `translateY(${scrollPercent * 12}px)`;
            });

            const bgMusic = new Audio('Assets/Musics/audio2.mp3');
            bgMusic.loop = true;
            bgMusic.volume = 0;

            let musicStarted = false;

            function initMusic() {
                if (musicStarted) return;
                musicStarted = true;
                bgMusic.play().catch(e => {
                    document.addEventListener('click', function startMusic() {
                        bgMusic.play();
                        document.removeEventListener('click', startMusic);
                    }, { once: true });
                });

                let vol = 0;
                const fadeInterval = setInterval(() => {
                    if (vol < 0.2) {
                        vol += 0.003;
                        bgMusic.volume = vol;
                    } else {
                        clearInterval(fadeInterval);
                    }
                }, 200);
            }

            setTimeout(initMusic, 2600);

            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    bgMusic.pause();
                } else {
                    bgMusic.play();
                }
            });

            // ---------- LIVING ICON ----------
            const livingIcon = document.getElementById('livingIcon');
            const blackScreen = document.getElementById('blackScreen');
            const blackScreenMessage = document.getElementById('blackScreenMessage');
            
            let clickCount = parseInt(localStorage.getItem('muteClickCount') || '0');
            
            function playMuteSound(index) {
                bgMusic.pause();
                const muteSound = new Audio(`Assets/Mute/${index}.mp3`);
                muteSound.volume = 0.4;
                muteSound.play();
                
                const body = document.body;
                
                switch(index) {
                    case 1:
                        body.classList.add('shake-effect');
                        setTimeout(() => body.classList.remove('shake-effect'), 400);
                        break;
                    case 2:
                        body.classList.add('shake-effect');
                        setTimeout(() => body.classList.remove('shake-effect'), 500);
                        document.querySelector('.video-layer').style.filter = 'brightness(0.55) contrast(1.45) hue-rotate(5deg)';
                        setTimeout(() => {
                            document.querySelector('.video-layer').style.filter = 'brightness(0.58) contrast(1.35) hue-rotate(0deg)';
                        }, 600);
                        break;
                    case 3:
                        body.classList.add('glitch-effect');
                        setTimeout(() => body.classList.remove('glitch-effect'), 500);
                        textBlocks.forEach(block => {
                            block.style.opacity = '0.6';
                            setTimeout(() => { block.style.opacity = ''; }, 200);
                        });
                        break;
                    case 4:
                        body.classList.add('red-bleed');
                        document.querySelector('.overlay-dark').style.background = 'radial-gradient(circle at 50% 50%, rgba(25,5,5,0.85) 0%, rgba(3,3,3,0.98) 100%)';
                        body.classList.add('shake-effect');
                        setTimeout(() => {
                            body.classList.remove('red-bleed');
                            document.querySelector('.overlay-dark').style.background = 'radial-gradient(circle at 50% 50%, rgba(5,5,5,0.82) 0%, rgba(3,3,3,0.96) 100%)';
                            body.classList.remove('shake-effect');
                        }, 800);
                        break;
                    case 5:
                        body.classList.add('glitch-effect');
                        document.querySelector('.video-layer').style.filter = 'brightness(0.3) contrast(2.0) hue-rotate(25deg)';
                        document.querySelector('.overlay-dark').style.background = '#000';
                        
                        setTimeout(() => {
                            document.body.style.opacity = '0';
                        }, 500);
                        
                        setTimeout(() => {
                            document.body.style.opacity = '0';
                            blackScreen.style.display = 'flex';
                            setTimeout(() => {
                                blackScreen.style.opacity = '1';
                            }, 100);
                        }, 800);
                        
                        muteSound.addEventListener('ended', function() {
                            setTimeout(() => {
                                blackScreenMessage.textContent = 'Try again… carefully.';
                                blackScreenMessage.style.opacity = '1';
                            }, 10000);
                        });
                        break;
                }
                
                muteSound.addEventListener('ended', function() {
                    if (index < 5) {
                        bgMusic.play();
                    }
                });
            }
            
            livingIcon.addEventListener('click', function() {
                clickCount = (clickCount % 5) + 1;
                localStorage.setItem('muteClickCount', clickCount);
                playMuteSound(clickCount);
            });

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.addEventListener('click', function() {
                document.body.style.opacity = '0';
                const fadeOut = setInterval(() => {
                    if (bgMusic.volume > 0.01) {
                        bgMusic.volume -= 0.01;
                    } else {
                        clearInterval(fadeOut);
                        bgMusic.pause();
                    }
                }, 20);
                setTimeout(() => {
                    window.location.href = 'page3.html';
                }, 400);
            });

            nextBtn.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'turning...';
                document.body.style.opacity = '0';
                const fadeOut = setInterval(() => {
                    if (bgMusic.volume > 0.01) {
                        bgMusic.volume -= 0.01;
                    } else {
                        clearInterval(fadeOut);
                        bgMusic.pause();
                    }
                }, 20);
                setTimeout(() => {
                    window.location.href = 'page5.html';
                }, 400);
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    prevBtn.click();
                } else if (e.key === 'ArrowRight' || e.key === ' ') {
                    e.preventDefault();
                    if (!nextBtn.disabled) {
                        nextBtn.click();
                    }
                } else if (e.key === 'm' || e.key === 'M') {
                    e.preventDefault();
                    livingIcon.click();
                }
            });

            const videoEl = document.querySelector('video');
            videoEl.addEventListener('error', function() {
                this.style.display = 'none';
            });

            setInterval(() => {
                if (Math.random() < 0.06) {
                    document.body.style.animation = 'none';
                    setTimeout(() => {
                        document.body.style.animation = 'subtle-flicker 26s infinite';
                    }, 30);
                }
            }, 12000);
        });
    </script>
</body>
</html>
